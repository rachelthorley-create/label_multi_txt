<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Label Generator (JSON Export) â€” With Quantity</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:18px;display:flex;flex-direction:column;align-items:center}
  form{width:100%;max-width:900px}
  label{display:block;margin:6px 0}
  input[type="text"],input[type="number"],input[type="email"],select{width:100%;padding:6px;box-sizing:border-box}
  .button-row{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
  .advanced{display:none;border:1px solid #ddd;padding:10px;border-radius:6px;margin-top:8px}
  .label-block{border:1px solid #eee;padding:8px;margin:8px 0;border-radius:6px}
  #allPreviews{display:flex;flex-direction:column;gap:38px;margin-top:10px}
  canvas{width:378px;height:283px;border:1px solid #ccc;border-radius:6px}
</style>
</head>
<body>

<h2>Label Generator v1.27</h2>
<p style="max-width:900px;text-align:center">
Edit Label 1 and add more labels below. Click <strong>Preview Label(s)</strong> to see your labels. Click <strong>Download Layout Instructions</strong> to export engraving instruction file for all labels.
</p>

<!-- Name & Email for submission -->
<div style="width:100%;max-width:900px;margin-bottom:12px;">
  <label>Your Name: <input id="userName" type="text"></label>
  <label>Your Email: <input id="userEmail" type="email"></label>
</div>

<form id="mainForm" onsubmit="return false;">
<h3>Label 1 (Primary Label)</h3>
<label>Line 1: <input id="line1" type="text" value="1st line"></label>
<label>Line 2: <input id="line2" type="text" value="2nd line"></label>
<label>Line 3: <input id="line3" type="text" value="3rd line"></label>
<label>How many of this design? 
  <input id="qty1" type="number" min="1" value="1" style="width:60px">
</label>

<div class="button-row" id="topButtons">
  <button id="previewBtn" type="button">Preview Label(s)</button>
  <button id="downloadBtn" type="button">Download engraving Instruction file</button>
  <button id="toggleAdvanced" type="button">Show Advanced Options</button>
  <button id="submitBtn" type="button">Submit Labels</button>
</div>

<div class="advanced" id="advancedOptions">
  <!-- advanced controls unchanged -->
  <!-- ... (same as your original advancedOptions block) -->
</div>
</form>

<h3>Multiple Labels</h3>
<label>Total labels (including label 1): <input id="numLabels" type="number" min="1" value="1"></label>
<div id="labelsContainer"></div>
<div id="allPreviews"></div>

<script>
const mmToPx=mm=>Math.round(mm*3.78);

/* --- DOM refs --- */
const line1=document.getElementById('line1');
const line2=document.getElementById('line2');
const line3=document.getElementById('line3');
const qty1=document.getElementById('qty1');

const previewBtn=document.getElementById('previewBtn');
const downloadBtn=document.getElementById('downloadBtn');
const submitBtn=document.getElementById('submitBtn');
const toggleAdvancedBtn=document.getElementById('toggleAdvanced');
const advancedOptions=document.getElementById('advancedOptions');

const numLabelsEl=document.getElementById('numLabels');
const labelsContainer=document.getElementById('labelsContainer');
const allPreviews=document.getElementById('allPreviews');

const userName=document.getElementById('userName');
const userEmail=document.getElementById('userEmail');

/* advanced controls */
const largeSize=document.getElementById('largeSize');
const smallSize=document.getElementById('smallSize');
const line3Size=document.getElementById('line3Size');
const link23=document.getElementById('link23');
const gap12=document.getElementById('gap12');
const gap23=document.getElementById('gap23');
const linkGaps=document.getElementById('linkGaps');
const textShift=document.getElementById('textShift');
const font1=document.getElementById('font1');
const font2=document.getElementById('font2');
const font3=document.getElementById('font3');
const bold1=document.getElementById('bold1');
const italic1=document.getElementById('italic1');
const bold2=document.getElementById('bold2');
const italic2=document.getElementById('italic2');
const bold3=document.getElementById('bold3');
const italic3=document.getElementById('italic3');

const largeSizeLabel=document.getElementById('largeSizeLabel');
const smallSizeLabel=document.getElementById('smallSizeLabel');
const line3SizeLabel=document.getElementById('line3SizeLabel');
const gap12Label=document.getElementById('gap12Label');
const gap23Label=document.getElementById('gap23Label');
const textShiftLabel=document.getElementById('textShiftLabel');

function updateNumericLabels(){
  largeSizeLabel.textContent=largeSize.value;
  smallSizeLabel.textContent=smallSize.value;
  line3SizeLabel.textContent=line3Size.value;
  gap12Label.textContent=gap12.value;
  gap23Label.textContent=gap23.value;
  textShiftLabel.textContent=textShift.value;
}

function renderLabelInputs(){
  const n=Math.max(1,parseInt(numLabelsEl.value||1));
  labelsContainer.innerHTML='';
  for(let i=2;i<=n;i++){
    const block=document.createElement('div');
    block.className='label-block';
    block.innerHTML=`
      <h4>Label ${i}</h4>
      <label>Line 1: <input class="multi1" type="text" value="1st line"></label>
      <label>Line 2: <input class="multi2" type="text" value="2nd line"></label>
      <label>Line 3: <input class="multi3" type="text" value="3rd line"></label>
      <label>How many of this design? <input class="qty" type="number" min="1" value="1" style="width:60px"></label>
    `;
    labelsContainer.appendChild(block);
  }
}

/* Collect all label data */
function collectData(){
  const total=Math.max(1,parseInt(numLabelsEl.value||1));
  const obj={
    canvas:{width_mm:100,height_mm:75,corner_radius_mm:2,circle_diameter_mm:6,circle_top_mm:6,margin_side_mm:6,top_margin_extra_mm:10},
    global:{text_shift_mm:parseFloat(textShift.value||0),gap12_mm:parseFloat(gap12.value||0),gap23_mm:parseFloat(gap23.value||0),linkGaps:linkGaps.checked,linkLine3To2:link23.checked},
    sizes:{line1_size:parseFloat(largeSize.value),line2_size:parseFloat(smallSize.value),line3_size:link23.checked?parseFloat(smallSize.value):parseFloat(line3Size.value)},
    fonts:{line1:font1.value,line2:font2.value,line3:font3.value,line1_bold:bold1.checked,line1_italic:italic1.checked,line2_bold:bold2.checked,line2_italic:italic2.checked,line3_bold:bold3.checked,line3_italic:italic3.checked},
    labels:[]
  };

  // Label 1
  obj.labels.push({
    name:"Label 1",
    qty:parseInt(qty1.value||1),
    lines:{
      line1:{text:line1.value||'',font:font1.value,size:obj.sizes.line1_size,bold:bold1.checked,italic:italic1.checked},
      line2:{text:line2.value||'',font:font2.value,size:obj.sizes.line2_size,bold:bold2.checked,italic:italic2.checked},
      line3:{text:line3.value||'',font:font3.value,size:obj.sizes.line3_size,bold:bold3.checked,italic:italic3.checked}
    }
  });

  // Additional labels
  const m1=document.querySelectorAll('.multi1');
  const m2=document.querySelectorAll('.multi2');
  const m3=document.querySelectorAll('.multi3');
  const mq=document.querySelectorAll('.qty');
  for(let i=0;i<m1.length;i++){
    obj.labels.push({
      name:`Label ${i+2}`,
      qty:parseInt(mq[i].value||1),
      lines:{
        line1:{text:m1[i].value||'',font:font1.value,size:obj.sizes.line1_size,bold:bold1.checked,italic:italic1.checked},
        line2:{text:m2[i].value||'',font:font2.value,size:obj.sizes.line2_size,bold:bold2.checked,italic:italic2.checked},
        line3:{text:m3[i].value||'',font:font3.value,size:obj.sizes.line3_size,bold:bold3.checked,italic:italic3.checked}
      }
    });
  }
  return obj;
}

/* Submit data to Google Sheet */
function submitToGoogleSheet(){
  const name=userName.value.trim();
  const email=userEmail.value.trim();
  if(!name || !email) return alert("Please enter your name and email");

  const data=collectData();
  if(!data.labels.length) return alert("No labels to submit");

  fetch("YOUR_GOOGLE_APPS_SCRIPT_URL",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({name,email,data})
  })
  .then(res=>res.json())
  .then(resp=>alert(`Submission successful! Reference: ${resp.reference}`))
  .catch(err=>alert("Submission failed: "+err));
}

/* Event listeners */
toggleAdvancedBtn.addEventListener('click',()=>{
  advancedOptions.style.display=advancedOptions.style.display==='block'?'none':'block';
  toggleAdvancedBtn.textContent=advancedOptions.style.display==='block'?'Hide Advanced Options':'Show Advanced Options';
});

numLabelsEl.addEventListener('change',renderLabelInputs);
renderLabelInputs();
[largeSize,smallSize,line3Size,gap12,gap23,textShift].forEach(el=>el.addEventListener('input',updateNumericLabels));
updateNumericLabels();

previewBtn.addEventListener('click',()=>{
  const data=collectData();
  allPreviews.innerHTML='';
  data.labels.forEach(lbl=>{
    const header=document.createElement('div');
    header.style.fontWeight='bold';
    header.textContent=`${lbl.name} - ${lbl.qty} copies`;
    allPreviews.appendChild(header);
    // draw single canvas
    const c=document.createElement('canvas');
    c.width=378; c.height=283;
    const ctx=c.getContext('2d');
    ctx.fillStyle='black';
    ctx.fillRect(0,0,c.width,c.height);
    ctx.fillStyle='white';
    ctx.font='20px Arial';
    ctx.fillText(lbl.lines.line1.text,50,50);
    allPreviews.appendChild(c);
  });
});

downloadBtn.addEventListener('click',()=>{
  const data=collectData();
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='labels.json'; a.click();
});

submitBtn.addEventListener('click',submitToGoogleSheet);
</script>
</body>
</html>



<!-- Save as label-generator.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Label Generator — export JSON</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:18px;display:flex;flex-direction:column;align-items:center}
  form{width:100%;max-width:900px}
  label{display:block;margin:8px 0}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .small{width:120px}
  canvas{border:1px solid #ccc;border-radius:6px;margin:12px 0}
  #allPreviews{display:flex;flex-direction:column;gap:38px;margin-top:18px}
  .mini{width:378px;height:283px;object-fit:contain;border:1px solid #ddd}
  .advanced{display:none;border:1px solid #ddd;padding:10px;border-radius:8px;margin-top:8px}
  .label-block{border:1px solid #eee;padding:8px;margin:6px 0;border-radius:6px}
  button{padding:6px 10px;margin-right:8px}
</style>
</head>
<body>
  <h2>Label Generator (JSON instructions)</h2>
  <p style="max-width:900px;text-align:center">
    Design Label 1, then add additional labels below. Click <strong>Update Text</strong> to refresh the PNG preview. Use <strong>Preview All</strong> to see all labels stacked. When ready, click <strong>Download Instructions (JSON)</strong> to save a file that contains every parameter needed to recreate the engraving SVGs.
  </p>

  <form id="mainForm">
    <h3>Label 1 (Primary Label - this is used to design the layout of your labels. I suggest you use the one where you want the most text for this)</h3>
    <label>Line 1: <input id="line1" type="text" value="1st line" /></label>
    <label>Line 2: <input id="line2" type="text" value="2nd line" /></label>
    <label>Line 3: <input id="line3" type="text" value="3rd line" /></label>

    <div class="row" style="margin-top:8px">
      <button type="submit">Update Text</button>
      <button type="button" id="downloadJsonBtn">Download Instructions (JSON)</button>
      <button type="button" id="previewAllBtn">Preview All</button>
    </div>

    <div style="margin-top:12px">
      <div class="row">
        <div>
          <label>Large text size (line1): <span id="largeLabel">54</span></label>
          <input id="largeSize" type="range" min="20" max="100" value="54" />
        </div>
        <div>
          <label>Small text size (line2): <span id="smallLabel">27</span></label>
          <input id="smallSize" type="range" min="10" max="60" value="27" />
        </div>
      </div>

      <div style="margin-top:8px">
        <button type="button" id="toggleAdvanced">Show Advanced Options</button>
        <div class="advanced" id="advanced">
          <div class="row">
            <div>
              <label>Line 3 size: <span id="line3Label">27</span></label>
              <input id="line3Size" type="range" min="10" max="60" value="27" />
              <div><label><input id="link23" type="checkbox" checked /> Link line3 to line2</label></div>
            </div>

            <div>
              <label>Gap line1→2: <span id="gap12Label">4</span></label>
              <input id="gap12" type="range" min="0" max="20" value="4" />
              <label>Gap line2→3: <span id="gap23Label">3</span></label>
              <input id="gap23" type="range" min="0" max="20" value="3" />
              <div><label><input id="linkGaps" type="checkbox" /> Make gap2-3 = gap1-2</label></div>
            </div>

            <div>
              <label>Text shift (vertical): <span id="textShiftLabel">0</span></label>
              <input id="textShift" type="range" min="-20" max="20" value="0" />
            </div>
          </div>

          <div style="margin-top:8px">
            <div class="row">
              <div>
                <label>Line1 font</label>
                <select id="font1"><option>Arial</option><option>Verdana</option><option>Courier New</option></select>
                <div><label><input id="bold1" type="checkbox" checked /> Bold</label></div>
                <div><label><input id="italic1" type="checkbox" /> Italic</label></div>
              </div>

              <div>
                <label>Line2 font</label>
                <select id="font2"><option>Arial</option><option>Verdana</option><option>Courier New</option></select>
                <div><label><input id="bold2" type="checkbox" /> Bold</label></div>
                <div><label><input id="italic2" type="checkbox" checked /> Italic</label></div>
              </div>

              <div>
                <label>Line3 font</label>
                <select id="font3"><option>Arial</option><option>Verdana</option><option>Courier New</option></select>
                <div><label><input id="bold3" type="checkbox" /> Bold</label></div>
                <div><label><input id="italic3" type="checkbox" /> Italic</label></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr style="margin:18px 0" />

    <h3>Additional labels (Label 2+)</h3>
    <div class="row">
      <label class="small">Number of additional labels:
        <input id="numLabels" type="number" min="0" value="0" />
      </label>
      <div style="flex:1"></div>
    </div>
    <div id="labelsContainer"></div>
  </form>

  <!-- Canvas preview (PNG) -->
  <canvas id="previewCanvas" width="378" height="283"></canvas>

  <div id="allPreviews"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
/* Label Generator script — exports JSON. */
const mmToPx = mm => mm * 3.78;

const previewCanvas = document.getElementById('previewCanvas');
const pctx = previewCanvas.getContext('2d');

const inputs = {
  line1: document.getElementById('line1'),
  line2: document.getElementById('line2'),
  line3: document.getElementById('line3'),
  largeSize: document.getElementById('largeSize'),
  smallSize: document.getElementById('smallSize'),
  line3Size: document.getElementById('line3Size'),
  link23: document.getElementById('link23'),
  gap12: document.getElementById('gap12'),
  gap23: document.getElementById('gap23'),
  linkGaps: document.getElementById('linkGaps'),
  textShift: document.getElementById('textShift'),
  font1: document.getElementById('font1'),
  font2: document.getElementById('font2'),
  font3: document.getElementById('font3'),
  bold1: document.getElementById('bold1'),
  italic1: document.getElementById('italic1'),
  bold2: document.getElementById('bold2'),
  italic2: document.getElementById('italic2'),
  bold3: document.getElementById('bold3'),
  italic3: document.getElementById('italic3')
};

const labelEls = {
  largeLabel: document.getElementById('largeLabel'),
  smallLabel: document.getElementById('smallLabel'),
  line3Label: document.getElementById('line3Label'),
  gap12Label: document.getElementById('gap12Label'),
  gap23Label: document.getElementById('gap23Label'),
  textShiftLabel: document.getElementById('textShiftLabel')
};

function updateNumericLabels(){
  labelEls.largeLabel.textContent = inputs.largeSize.value;
  labelEls.smallLabel.textContent = inputs.smallSize.value;
  labelEls.line3Label.textContent = inputs.line3Size.value;
  labelEls.gap12Label.textContent = inputs.gap12.value;
  labelEls.gap23Label.textContent = inputs.gap23.value;
  labelEls.textShiftLabel.textContent = inputs.textShift.value;
}

/* multiple labels */
let labels = []; // stores objects for label 2..n
const labelsContainer = document.getElementById('labelsContainer');
const numLabelsEl = document.getElementById('numLabels');

function renderExtraInputs(){
  const n = parseInt(numLabelsEl.value) || 0;
  labelsContainer.innerHTML = '';
  labels = [];
  for(let i=0;i<n;i++){
    const block = document.createElement('div');
    block.className = 'label-block';
    block.innerHTML = `<strong>Label ${i+2}</strong>
      <div><label>Line 1: <input class="line1multi" value="1st line"></label></div>
      <div><label>Line 2: <input class="line2multi" value="2nd line"></label></div>
      <div><label>Line 3: <input class="line3multi" value="3rd line"></label></div>`;
    labelsContainer.appendChild(block);
    labels.push({line1:'1st line',line2:'2nd line',line3:'3rd line'});
  }
}
numLabelsEl.addEventListener('change',renderExtraInputs);
renderExtraInputs();

function updateExtraData(){
  const l1s = document.querySelectorAll('.line1multi');
  const l2s = document.querySelectorAll('.line2multi');
  const l3s = document.querySelectorAll('.line3multi');
  labels.forEach((lbl,i)=>{
    lbl.line1 = (l1s[i] && l1s[i].value) || '';
    lbl.line2 = (l2s[i] && l2s[i].value) || '';
    lbl.line3 = (l3s[i] && l3s[i].value) || '';
  });
}

/* drawing to canvas (PNG preview). This uses same math as renderer uses for SVG layout. */
function drawToCanvasForLabel(labelObj){
  // canvas dimensions in px (we use mmToPx conversion)
  const W = mmToPx(100), H = mmToPx(75);
  const cornerR = mmToPx(2), circleR = mmToPx(3), circleTop = mmToPx(6);
  const margin = mmToPx(5);
  const topMarginExtra = mmToPx(2);
  const textShiftPx = mmToPx(parseFloat(inputs.textShift.value) || 0);

  // fonts and sizes
  const size1 = parseInt(inputs.largeSize.value);
  const size2 = parseInt(inputs.smallSize.value);
  const size3 = inputs.link23.checked ? size2 : parseInt(inputs.line3Size.value);

  const gap12 = mmToPx(parseFloat(inputs.gap12.value));
  const gap23 = inputs.linkGaps.checked ? gap12 : mmToPx(parseFloat(inputs.gap23.value));

  // lines array
  const lines = [
    { text: labelObj.line1 || '', size: size1, font: inputs.font1.value, bold: inputs.bold1.checked, italic: inputs.italic1.checked },
    { text: labelObj.line2 || '', size: size2, font: inputs.font2.value, bold: inputs.bold2.checked, italic: inputs.italic2.checked },
    { text: labelObj.line3 || '', size: size3, font: inputs.font3.value, bold: inputs.bold3.checked, italic: inputs.italic3.checked }
  ].filter(l=>l.text && l.text.trim() !== '');

  // compute total block height
  let totalHeight = 0;
  lines.forEach((l,i)=>{ totalHeight += l.size; if(i===0 && lines.length>1) totalHeight += gap12; if(i===1 && lines.length>2) totalHeight += gap23; });

  const topTextY = circleTop + circleR + topMarginExtra + textShiftPx;
  const bottomTextY = H - margin;
  const availableHeight = bottomTextY - topTextY;

  // start baseline y (approx)
  let curY = topTextY + (availableHeight - totalHeight)/2 + (lines[0] ? lines[0].size*0.75 : 0);

  // draw background rounded rect (black)
  pctx.clearRect(0,0,previewCanvas.width,previewCanvas.height);
  pctx.fillStyle = '#000';
  pctx.beginPath();
  pctx.moveTo(cornerR,0);
  pctx.lineTo(W-cornerR,0);
  pctx.quadraticCurveTo(W,0,W,cornerR);
  pctx.lineTo(W,H-cornerR);
  pctx.quadraticCurveTo(W,H,W-cornerR,H);
  pctx.lineTo(cornerR,H);
  pctx.quadraticCurveTo(0,H,0,H-cornerR);
  pctx.lineTo(0,cornerR);
  pctx.quadraticCurveTo(0,0,cornerR,0);
  pctx.closePath();
  pctx.fill();

  // circle
  pctx.beginPath();
  pctx.arc(W/2, circleTop+circleR, circleR, 0, Math.PI*2);
  pctx.fillStyle = '#fff';
  pctx.fill();

  // text
  pctx.textAlign = 'center';
  pctx.fillStyle = '#fff';
  lines.forEach((line,i)=>{
    let style = '';
    if(line.bold) style += 'bold ';
    if(line.italic) style += 'italic ';
    style += `${line.size}px ${line.font}`;
    pctx.font = style;
    // horizontal fit
    const maxW = W - 2*margin;
    const measured = pctx.measureText(line.text).width;
    const scaleX = Math.min(1, maxW / measured);
    pctx.save();
    pctx.translate(W/2, curY);
    pctx.scale(scaleX,1);
    pctx.fillText(line.text, 0, 0);
    pctx.restore();
    if(i===0 && lines.length>1) curY += gap12 + lines[1].size;
    if(i===1 && lines.length>2) curY += gap23 + lines[2].size;
  });
}

/* helper to draw preview for Label1 (from top inputs) */
function drawPrimaryPreview(){
  const label = { line1: inputs.line1.value, line2: inputs.line2.value, line3: inputs.line3.value };
  drawToCanvasForLabel(label);
}

/* Preview All: stack Label1 then additional labels vertically with 10mm spacing */
function previewAll(){
  updateExtraData();
  const container = document.getElementById('allPreviews');
  container.innerHTML = '';
  const spacingPx = mmToPx(10);

  // primary
  drawToCanvasForLabel({line1: inputs.line1.value, line2: inputs.line2.value, line3: inputs.line3.value});
  const c1 = document.createElement('canvas');
  c1.width = previewCanvas.width;
  c1.height = previewCanvas.height;
  c1.getContext('2d').drawImage(previewCanvas,0,0);
  container.appendChild(c1);

  labels.forEach(lbl=>{
    drawToCanvasForLabel(lbl);
    const c = document.createElement('canvas');
    c.width = previewCanvas.width; c.height = previewCanvas.height;
    c.getContext('2d').drawImage(previewCanvas,0,0);
    container.appendChild(c);
    // vertical gap is handled by column layout with gap set in CSS
  });
}

/* JSON export — contains every numeric parameter, fonts, spacing and text */
function buildJsonInstructions(){
  updateExtraData();
  const data = {
    canvas: {
      width_mm: 100,
      height_mm: 75,
      corner_radius_mm: 2,
      circle_diameter_mm: 6,
      circle_top_mm: 6,
      margin_side_mm: 5,
      top_margin_extra_mm: 2
    },
    global: {
      text_shift_mm: parseFloat(inputs.textShift.value) || 0,
      gap12_mm: parseFloat(inputs.gap12.value) || 0,
      gap23_mm: parseFloat(inputs.gap23.value) || 0,
      linkGaps: inputs.linkGaps.checked,
      linkLine3To2: inputs.link23.checked
    },
    fonts: {
      line1: inputs.font1.value,
      line2: inputs.font2.value,
      line3: inputs.font3.value,
      line1_bold: inputs.bold1.checked,
      line1_italic: inputs.italic1.checked,
      line2_bold: inputs.bold2.checked,
      line2_italic: inputs.italic2.checked,
      line3_bold: inputs.bold3.checked,
      line3_italic: inputs.italic3.checked
    },
    sizes: {
      line1_size: parseInt(inputs.largeSize.value),
      line2_size: parseInt(inputs.smallSize.value),
      line3_size: inputs.link23.checked ? parseInt(inputs.smallSize.value) : parseInt(inputs.line3Size.value)
    },
    labels: []
  };

  // Label 1
  data.labels.push({
    name: "Label 1",
    lines: {
      line1: { text: inputs.line1.value || "", font: inputs.font1.value, size: data.sizes.line1_size, bold: inputs.bold1.checked, italic: inputs.italic1.checked },
      line2: { text: inputs.line2.value || "", font: inputs.font2.value, size: data.sizes.line2_size, bold: inputs.bold2.checked, italic: inputs.italic2.checked },
      line3: { text: inputs.line3.value || "", font: inputs.font3.value, size: data.sizes.line3_size, bold: inputs.bold3.checked, italic: inputs.italic3.checked }
    }
  });

  // Additional labels
  labels.forEach((lbl,i)=>{
    data.labels.push({
      name: `Label ${i+2}`,
      lines: {
        line1: { text: lbl.line1||"", font: inputs.font1.value, size: data.sizes.line1_size, bold: inputs.bold1.checked, italic: inputs.italic1.checked },
        line2: { text: lbl.line2||"", font: inputs.font2.value, size: data.sizes.line2_size, bold: inputs.bold2.checked, italic: inputs.italic2.checked },
        line3: { text: lbl.line3||"", font: inputs.font3.value, size: data.sizes.line3_size, bold: inputs.bold3.checked, italic: inputs.italic3.checked }
      }
    });
  });

  return data;
}

/* Download JSON */
document.getElementById('downloadJsonBtn').addEventListener('click',()=>{
  const data = buildJsonInstructions();
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'labels.json';
  link.click();
});

/* button handlers */
document.getElementById('previewAllBtn').addEventListener('click', previewAll);
document.getElementById('toggleAdvanced').addEventListener('click',()=>{
  const adv = document.getElementById('advanced');
  adv.style.display = (adv.style.display === 'block') ? 'none' : 'block';
});

/* Update numeric labels only (no preview automatic update) */
[inputs.largeSize, inputs.smallSize, inputs.line3Size, inputs.gap12, inputs.gap23, inputs.textShift].forEach(el=>{
  el.addEventListener('input', updateNumericLabels);
});

/* Update Text button — only action that redraws preview */
document.getElementById('mainForm').addEventListener('submit', (ev)=>{
  ev.preventDefault();
  drawPrimaryPreview();
});

/* initial numeric labels and initial preview */
updateNumericLabels();
drawPrimaryPreview();
</script>
</body>
</html>
